# Packages ----------------------------------------------------------------
library(tidyverse)
library(readxl)



# Import dasta -------------------------------------------------------------
fruit <- 
    read_excel("data/Soo_2010/raw/SooWaiKit_native fruit size.xls", 
               sheet = "Forest Species (emp+gen sub)") %>% 
    # remove comment row
    slice(-1) %>% 
    select(
        Name.auth,
        Dispersal,  # dispersal_syndrome
        Pollination,   # pollination_syndrome
        `Fruit type by Corlett`:`No. Seed`,   # fruit_type
        -`Fruit Width (cm)...27`, # this is a rounding column
        `Fruit Width (cm)` = `Fruit Width (cm)...26`
    )  %>% 
    # match numeric key to descriptions
    mutate(
        Dispersal = 
            case_match(Dispersal,
                       1 ~ "adhesion (spines, hooks, bars or callus hairs)",
                       2 ~ "ingestion (berries, drupes or aggregate fruits)",
                       3 ~ "wind (wing-like structures)",                   
                       4 ~ "water (fibrous endocarp or viviparous)",         
                       5 ~ "others"),
        Pollination = 
            case_match(Pollination,
                       1 ~ "insect",
                       2 ~ "mammal",
                       3 ~ "bird",                   
                       4 ~ "wind",         
                       5 ~ "others")
    ) 

# Tidy up

# IMPROVE ME: number extracted from string below may not be 100% foolproof

# handle numeric variables which are a mixture of range and mean separately
# function to extract min and max from string
get_number <- function(text, type) {
    num <- str_extract_all(text, "\\d+(\\.\\d+)?")
    num <- as.numeric(unlist(num))
    switch(type,
           min = min(num),
           max = max(num))
}

fruit_cont <- 
    fruit %>% 
    select(Name.auth, 
           `Fruit Length (cm)`,
           `Fruit Width (cm)`,
           `Seed Length (mm)`,
           `Seed width (mm)`,
           `No. Seed`) %>% 
    pivot_longer(cols = -Name.auth,
                 names_to = "Trait",
                 values_drop_na = TRUE) %>% 
    rowwise() %>% 
    mutate(min = get_number(value, "min"),
           max = get_number(value, "max")) %>% 
    ungroup() %>% 
    filter(is.finite(min),
           is.finite(max)) %>% 
    mutate(mean = ifelse(min == max, min, NA),
           min  = ifelse(min == max, NA, min),
           max  = ifelse(min == max, NA, max)) %>% 
    select(-value) %>% 
    pivot_wider(names_from = Trait,
                values_from = c(min, max, mean),
                names_glue = "{Trait} {.value}")

# export output
out <- 
    fruit %>% 
    select(Name.auth, 
           Dispersal:`Fruit type by Corlett`,
           `Fruit Colour`:`Fruit Description`,
           Aril:`Seed Colour`) %>% 
    left_join(fruit_cont)

write_csv(out, "data/Soo_2010/data.csv")

# Adding trait value substitutions
# https://traitecoevo.github.io/traits.build-book/tutorial_dataset_2.html#categorical_substitutions

dispersal_syndrome_map <- 
    data.frame(
        trait_name = "dispersal_syndrome",
        find = 
            c('ingestion (berries, drupes or aggregate fruits)', 
              'others', 
              'water (fibrous endocarp or viviparous)', 
              'wind (wing-like structures)'),
        replace = 
            c("endozoochory",
              "undefined",
              "hydrochory",
              "anemochory")
    )

fruit_type_map <-
    tribble(
        ~find, ~replace,
        'simple', "",
        'dehiscent', "",
        'protected', "",
        'ants', "",
        'carpel?', "",
        'infructescence', "multiple_fruit",
        'loculicidal capsule', "capsule",
        'drupe-like', "drupe",
        'carpel', "",
        'compound', "",
        'simple/compound', "",
        'drupaceous', "",
        'capsule (2-lobed)', "capsule",
        'not lobed', "",
        'leathery berry or capsule', "",
        'pod-like', "",
        'drupe (nut)', "drupe",
        'carpels', "",
        'capsule (loculicid)', "capsule",
        'pods', "legume",
        'berry (5 pyrenes)', "berry",
        'berry?', "berry",
        'fake fruit (receptacle)', "",
        'simple (bat)', "",
        'berried carpels', "",
        'drupe (berry-like)', "drupe",
        'spikes?', "",
        'drupe/ berry', "",
        'capsular', "",
        'green', "",
        'berry-like', "",
        'depressed-globose or slightly oblong', "",
        'subglobose', "",
        'oblong/ ellipsoid', "",
        'fused as syncarps', "",
        'fused fruiting heads', "",
        'fruiting heads', "",
        'lobed', "",
        'pod', "legume",
        'loculicidal capsules', "",
        'drupaceous carpel?', "",
        'berry-like carpel', "",
        'globose', "",
        'round', "",
        'obovoid', "",
        'berry (capsular)', "berry",
        'drupelet', "",
        'frostgrass', "",
        'baccate drupe', "",
        'paired follicles', "",
        'bats', "",
        'pseudocarp', "",
        'simple (mammal)', "",
        'lobular capsule', "",
        'drupe (plum-like)', "drupe"
    ) %>% 
    mutate(trait_name = "fruit_type")

fruit_colour_map <-
    tribble(
        ~find, ~replace,
        'shining reddish', "red",
        'rusty tomentose', "red",
        'bright pale green to orange', "green",
        'red, orange, brown or grey', "red",
        'brown, orange, yellow, white or green', "brown",
        'yellow or brown', "yellow",
        'reddish-brown', "brown",
        'brown, bright red or yellow', "brown",
        'yellow, orange or orange-red', "yellow",
        'brown or yellow', "brown",
        'brown or red', "brown",
        'brown or orange', "brown",
        'yellow, reddish-brown or orange-brown', "yellow",
        'brown, red, orange or pale yellow', "brown",
        'brown, red or yellow', "brown",
        'yellow or orange-brown', "yellow",
        'blue-green', "blue",
        'yellow to red then black', "black",
        'black or red', "black",
        'orange-red', "red",
        'dark green with white spots', "green",
        'black or purple', "black",
        'purple or green', "purple",
        'green to yellow/orange', "green",
        'bright red', "red",
        'red to crimson', "red",
        'pink (dry)', "pink",
        'yellow to pnk or red', "pink", 
        'glabrous red', "red",
        'red-brown to dark brown (dry)', "red",
        'deep yellow, cream-brown', "brown",
        'yellow, black (dry)', "yellow",
        'yellow, cream-brown (dry)', "yellow",
        'yellow, brown (dry)', "yellow",
        'scarlet', "red",
        'white with black spots', "white",
        'green to orange', "orange",
        'dark red', "red",
        'dark green', "green",
        'velvety dark yellow', "yellow",
        'deep claret-colour', "purple",
        'brick-red', "red",
        'yellowish', "yellow",
        'green turn dark blue', "blue",
        'yellow to red', "red",
        'yellow or orange', "yellow",
        'yellow, red, orange', "yellow",
        'greenish turn almost black', "black",
        'cherry-pink', "pink",
        'green turn black', "black",
        'reddish green', "green",
        'orange-yellow', "yellow",
        'shining balck', "black",
        'pale red', "red",
        'yellow with brown margin', "yellow",
        'green turn red', "red",
        'dark reddish brown (dry)', "brown",
        'pale brown', "brown",
        'pale brown (dry)', "brown",
        'pale reddish brown (dry)', "brown",
        'reddish brown (dry)', "brown",
        'dull purplish brown (dry)', "brown",
        'dark (dry)', "black",
        'dull pale reddish brown to greyish brown (dry)', "brown",
        'dark grey to black (dry)', "black",
        'green to dull red', "green",
        'green speckled white or dark green', "green",
        'green or yellowish turn glossy red, blue-black or purple', "red",
        'blue-black', "black",
        'yellow-orange', "orange",
        'green turn brown to blackish', "brown",
        'translucent pink to red', "red",
        'yellow to ornage', "yellow",
        'bright yellow', "yellow",
        'orange or yellow', "orange",
        'orange to orange-red', "orange",
        'semi-transparent pink', "pink",
        'dull green', "green",
        'chestnut red', "red",
        'dull grey-green', "green",
        'green or yellow turn black', "black",
        'yellow to blood-red', "red",
        'orange-brown', "brown",
        'dull red', "red",
        'crimson', "red",
        'white, cream, rarely tinged purple/pink, dark violet purple tip', "cream",
        'claret pink', "pink",
        'green to pink', "green",
        'dark blue', "blue",
        'bright yellow to orange', "orange",
        'white, pale green, pink, orange or yellow', "white",
        'green to yellow', "green",
        'brown, orange, yellow', "brown",
        'yellowish (dry)', "yellow",
        'green, tip purple', "green",
        'pink to blue', "blue",
        'chestnut, edges silvery', "brown",
        'deep brown', "brown",
        'yellowish brown', "brown",
        'yellow(scales)', "yellow",
        'dark brown', "brown",
        'yellowish (scales)', "yellow",
        'brownish yellow', "brown",
        'yellow (scales)', "yellow",
        'yellowish-green turning red when dry', "green",
        'pale green, green, or white to brwon when ripe', "brown",
        'dark red turn shining black', "red",
        'rugose', "red",
        'yellow turning dark purple', "purple",
        'yellowish-green (out); whitish (in)', "green",
        'yellowish-green', "green",
        'green turn yellow', "yellow",
        'green turn yellow to orange or red', "yellow",
        'yellowish-white', "cream",
        'orange-brown to orange', "brown",
        'thinly velvety brown to dark dull red', "brown",
        'greenish white to red', "green",
        'silky grey-green hairy', "green",
        'chestnut brown', "brown",
        'reddish orange', "orange",
        'dull dark blue', "blue",
        'yellowish to brownish', "brown",
        'dark brown or blackish (dry); green turn yellow (fresh)', "yellow",
        'greyish-brown (dry)', "brown",
        'orange to red turning black', "black",
        'yellow, red', "yellow",
        'dark green to red', "green",
        'red turning white', "white",
        'greyish-white', "grey",
        'glaucous-white, coffe-brown or black', "grey",
        'orange to red', "red",
        'sky-blue or red?', "",
        'yellow/orange', "yellow",
        'yellow to pink to red', "red",
        'yellowish or pinkish', "yellow",
        'orange/ reddish-brown/ scarlet to purple/ black', "purple",
        'yellowish to orange to pinkish to scarlet to black', "black",
        'whitish to pinkish', "pink",
        'greenish to whitish (with yellowish spots)', "green",
        'yellow to orange to red', "red",
        'white to pink to purple to blackish', "purple",
        'yellow to orange or red', "red",
        'orange to dark red', "red",
        'yellow to dark red', "red",
        'orange to purplish red', "red",
        'yellow to orange or red or dark purple', "orange",
        'oorange red to dark crimson', "red",
        'yellowish or red', "yellow",
        'yellow to red (seed figs)', "red",
        'greenish', "green",
        'yellow to orange to brownish to red', "red",
        'pinkish to dark red or orange or yellow', "red",
        'yellow to orange to purplish red', "red",
        'green? with brownish puberulous', "green",
        'orange-ochre to red', "red",
        'pink to dark purple', "purple",
        'yellowish?', "yellow",
        'white to pink, yellow, orange or to dark red', "red",
        'orange to red to blackish', "red",
        'yellow to red to crimson or to purple', "red",
        'yellow to orange', "orange",
        'pinkish to orange to red-brown to scarlet or to wine-red', "red",
        'pink to red (sometimes green)', "red",
        'green?', "green",
        'yellow to orange to crimson', "red",
        'brown-tomentose', "brown",
        'light-green to pink or purplish-green to dark-red', "red",
        'velvety pale', "purple",
        'pale green', "green",
        'vivid yellow', "yellow",
        'dull orange-yellow', "yellow",
        'green turn brownish yellow', "brown",
        'dull orange', "orange",
        'fleshy pink', "pink",
        'pinkish', "pink",
        'white to pink/purplish', "pink",
        'green turning golden yellow to orange', "yellow",
        'green to red/ shiny black', "green",
        'red-brown', "brown",
        'yellow(-green) or yellow-orange', "yellow",
        'dark brown (dry)', "brown",
        'yellowish or orange; dark brown or reddish-brown (dry)', "orange",
        'yellowish or red, dark brown to blackish (dry)', "red",
        'yellow to red, apricot, orange(-brown) flushed pink, blackish brown (dry)', "brown",
        'blackish (dry)', "black",
        'greenish yellow or orange', "green",
        '(green-)yellow, orange(-yellow), or red', "yellow",
        'white turning red and finally black', "black",
        'greenish yellow', "yellow",
        'red to black', "black",
        'green turn red then black', "black",
        'deep purple', "purple",
        'deep blue, purple or black', "purple",
        'rusty or orange', "red",
        'greyish, rusty hair', "red",
        'red(-brown) or apricot', "red",
        'rusty brown scurf', "brown",
        'yellowish or orange', "yellow",
        'yellow-brown or dark rusty', "brown",
        'yellow, golden-brown or red-brown', "brown",
        'light or dark brown or yellow', "brown",
        'yellow or red', "yellow",
        'yellow(-brown) or orange', "orange",
        'berry', "",
        'deep blue', "blue",
        'light blue', "blue",
        'greyish blue', "blue",
        'purple-black', "black",
        'dark purple/ black', "purple",
        'dark red to black', "red",
        'rose-pink', "pink",
        'green turn blue then black', "black",
        'yellow tinge', "yellow",
        'dark red then black', "black",
        'yellow turning reddish', "red",
        'green spotted white', "white",
        'green with pale dots', "green",
        'pale green turn blue', "blue",
        'bluish-green', "green",
        'pale brown/ brownish yellow or green-white', "brown",
        'yellowish or greyish-green', "yellow",
        'yellow to rose-red turn blackish', "red",
        'pale dull green or greyish turning brownish', "brown",
        'yellowish-green, yellow or red', "yellow",
        'grey-green', "green",
        'green to purple or bluish balck', "green",
        'blue, purple', "blue",
        'drupe', "",
        'pale green turn straw yellow', "yellow",
        'greyish green to dark green turn red to purplish', "red",
        'pink to dark red turn deep purple to blackish with purple juice', "purple",
        'green turn pink', "pink",
        'dark purple', "purple",
        'blackish', "black",
        'yellow-green turn pinkish to purple to blackish', "black",
        'green turn yellow to pinkish', "yellow",
        'purplish', "purple",
        'purplish to black', "black",
        'green turn yellowish to grey green', "green",
        'green turn light yellow, purplish', "yellow",
        'yellow-green turn purple', "purple",
        'green turn pale pale yellowish tinged with pink', "yellow",
        'dark blue to purple', "purple",
        'light green', "green",
        'apricot-coloured', "orange",
        'whitish to green', "green",
        'white to green', "green",
        'yellow-brown to apricot', "orange",
        'pale yellow or orange', "yellow",
        'greenish-yellow turning bright orange or apricot', "orange",
        'green- or pale yellow', "green",
        'pale yellow with reddish brown scurf', "yellow",
        '(yellow-)brown or rusty brown', "brown",
        'pitted light brown', "brown",
        'claret-coloured', "purple",
        'orange/ yellow', "orange",
        'greyish black', "grey",
        'rose pink', "pink",
        'green mottled with dark red', "green",
        'velvety-red with silvery tinge', "red",
        'rich vevety-red', "red",
        'plum-coloured', "black",
        'greyish-brown to red', "brown",
        'velvety brown', "brown",
        'greenish-yellow', "yellow",
        'orange or dark red', "orange",
        'shiny green turn yellow', "yellow",
        'cream colour turn black', "black",
        'yellow turning red', "red",
        'lemon-yellow to reddish-ornage turn purplish-black', "purple",
        'dull red turn black', "red",
        'bright orange', "orange",
        'pale green to white turn blue', "blue",
        'off white to green turn purple', "purple",
        'green with brown gloss', "green",
        'green turning white, red turning purple or black', "purple",
        'whitish and red turning purple and black', "black",
        'orange turn black', "black",
        'green turn yellow then purple', "purple",
        'green turn pale yellow then purplish', "purple",
        'grey-greeen turn black', "black",
        'green turn red, purple then black', "black",
        'greyish', "grey",
        'green or white dots', "green",
        'red or orange-red', "red",
        'orange or red', "orange",
        'orange-red or pinkish yellow', "red",
        'yelow, brownish', "yellow",
        'reddish', "red",
        'yellow or purple-black', "yellow",
        'pink or pale brown below, pale green upper', "green",
        'whitish above, dark green-purplish below', "green",
        'yellow flushed pink turn brilliant orange-red', "orange",
        'crimson scarlet', "red",
        'whitish', "white",
        'pink to purple', "purple",
        'yellow or orange to red', "red",
        'blue or black-purple', "blue",
        'royal blue', "blue",
        'pink, green, yellow or deep bluish-purple, drying warm-brown', "purple",
        'blue to black', "black",
        'white turn pale blue, drying pale brown', "blue",
        'waxy white tinged red', "white",
        'dark red turn black', "red",
        'green flushed rose purple', "purple",
        'pink to almost black', "black",
        'greenish pink to pink and dark red to purplish red', "red",
        'dark purplish red', "red",
        'opaque white', "white",
        'deep pink or dull scarlet to purple black', "purple",
        'pale green to white', "white",
        'pinkish to purple', "purple",
        'dark red to purple black', "red",
        'green becoming red', "red",
        'red or yellow', "red",
        'green to black, tinged purple', "purple",
        'pale to darker green turn pale orange', "orange",
        'green to red', "red",
        'green to dark red', "red",
        'green with white spots to yellow/orange', "green",
        'ornage-yellow', "yellow",
        'orange/red', "orange",
        'deep-orange/red', "orange",
        'grey-green to purplish', "purple",
        'yellowish orange or red and sometimes finally black', "black",
        'brownish orange', "orange",
        'ashy', "grey",
        'green turn purple then black', "black",
        'pale green, yellow, orange or reddish', "green",
        'cream, brown', "cream",
        'bluish', "blue",
        'light brown', "brown",
        'dark reddish', "red",
        'pinkish brown, dark spots', "brown",
        'yellowish green', "green",
        'light brown, dark reddish brown', "brown",
        'orange to pinkish', "pink",
        'red/ dark brown', "red",
        'yellow, orange or red', "yellow"
    ) %>% 
    mutate(trait_name = "fruit_colour")

seed_shape_map <-
    tribble(
        ~find, ~replace,
        'oval flat', "ovoid_flattened",
        'obovoid', "ovoid",
        'obovoid to cylindrical', "ovoid",
        'elliptic-oblong', "ellipsoid",
        'globose', 'globoid',
        'oblong', "ellipsoid",
        'pear-shaped', "ovoid",
        'plano-convex', "hemispheric_flattened",
        'oblong compressed', "ellipsoid_flattened",
        'flat curved', "discoid",
        'subglobose', "globoid_flattened",
        'kidney-shaped', "reniform",
        'transversely elliptic', "ellipsoid",
        'obovate', "ovoid",
        'orange-segment-shaped', "sectoroid",
        'scutiform', "discoid",
        'flattened', "discoid",
        'long flattened', "discoid",
        'curved into ring', "hemispheric_flattened",
        'ovoid, plano-convex, flattened', "ovoid_flattened",
        'flat', "discoid",
        'horseshoe-shaped', "comma-shaped",
        'elliptic flattened', "ellipsoid_flattened",
        'squarish to reniform', "reniform",
        'roundish to reniform', "reniform",
        'oblong-ellipsoid', "ellipsoid",
        'oblong globose', 'globoid',
        'elliptic to suboblong', "ellipsoid",
        'subreniform', "reniform",
        'globose or flattened', "globoid_flattened",
        'strongly flattened', "discoid",
        'obliquely triquetrous', "",
        'broadly ellipsoid', "ellipsoid",
        'globose to obovoid', 'globoid',
        'almost globose', 'globoid',
        'ovoid, flattened', "ovoid_flattened",
        'elliptic', "ellipsoid",
        'ovoid to globose', "ovoid",
        'horseshoe-shaped, narrow', "comma-shaped",
        'same as fruit shape', "",
        'ovoid to ellipsoid', "ovoid_elongated",
        'round to broadly ellipsoid', "globoid",
        'ellipsoid, flattened', "ellipsoid_flattened",
        'ovoid, oblong', "ellipsoid",
        'ellipsoid to globose', "ellipsoid",
        'globose to ellipsoid', "ellipsoid",
        'elongated, compressed', "ellipsoid_flattened",
        'wedge-shaped', "sectoroid",
        'ellipsoid-oblong', "ellipsoid",
        'flattened elliptic', "ellipsoid_flattened",
        'elongate ovoid', "ellipsoid",
        'oblique ovoid', "ovoid",
        'semi-ovate, pyriform', "ovoid",
        'ellipsoidal', "ellipsoid",
        'quadrangular-rhombic', "polyhedral",
        'semiglobose', "ellipsoid",
        'planoconvex to subglobular', "hemispheric_flattened",
        'broad ellipsoid', "ellipsoid",
        'ellippsoid', "ellipsoid",
        'subglobular', "globoid",
        'suborbicular', "globoid",
        'elliptic or orbicular', "ellipsoid",
        'straight', "cylindrical",
        'u-shaped', "comma-shaped",
        'globose or depressed globose', 'globoid',
        'obliquely ellipsoid', "ellipsoid",
        'ovoid convex-concave', "ovoid_flattened",
        'long ovoid', "ovoid_elongated",
        'cylindric', "cylindrical",
        'rounded', "ovoid",
        'oval', "ellipsoid",
        'linear', "cylindrical",
        'compressed ovoid', "ovoid_flattened",
        'globular', "globoid",
        'ovoid to round', "ovoid"
    ) %>%
    mutate(trait_name = "seed_shape")

fruit_dehiscence_map <-
    tribble(
        ~find, ~replace,
        'y', "dehiscent",
        'n', "indehiscent",
        'y?', "",
        'n or irregular', "",
        'irregular', "",
        'glabrous, woody', "",
        '?', "",
        'loculicidally', "dehiscent"
    ) %>% 
    mutate(trait_name = "fruit_dehiscence")

metadata_add_substitutions_list(
    "Soo_2010", 
    bind_rows(dispersal_syndrome_map, 
              fruit_type_map,
              fruit_colour_map,
              seed_shape_map,
              fruit_dehiscence_map))
